<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Copilot Usage Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --accent-color: #6366f1;
            --danger-color: #ef4444;
            --success-color: #10b981;
        }
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            margin: 0; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }
        .header {
            padding: 24px 40px;
            background-color: #ffffff;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h1 { font-size: 1.25rem; font-weight: 700; color: var(--text-main); margin: 0; }
        .container { 
            max-width: 1100px; 
            margin: 40px auto; 
            padding: 0 24px;
        }
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            align-items: center;
            flex-wrap: wrap;
        }
        .status-labels {
            display: flex;
            gap: 16px;
            margin-left: auto;
            align-items: center;
        }
        .update-item {
            display: flex;
            flex-direction: column;
            text-align: right;
        }
        select {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #ffffff;
            color: var(--text-main);
            transition: all 0.2s;
            cursor: pointer;
            outline: none;
        }
        select:hover {
            border-color: var(--accent-color);
            background-color: #f1f5f9;
        }
        .box {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 24px;
        }
        .box-header h2 { font-size: 1rem; font-weight: 600; color: var(--text-muted); margin: 0; text-transform: uppercase; letter-spacing: 0.05em; }
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .summary-card {
            padding: 24px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .summary-label { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
        .summary-value { font-size: 28px; font-weight: 700; color: var(--text-main); }
        .header-icon {
            width: 32px;
            height: 32px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .update-time {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }
        .schedule-info {
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0.8;
            margin-top: 1px;
        }
        .refresh-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            margin-left: 16px;
            padding-left: 16px;
            border-left: 1px solid var(--border-color);
        }
        .refresh-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .refresh-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background: #f5f3ff;
        }
        .auto-refresh-label {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        .header-content {
            display: flex;
            align-items: center;
        }
        .summary-card-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            margin-bottom: 4px;
            opacity: 1;
            color: var(--accent-color);
            flex-shrink: 0;
        }

        /* Tooltip style */
        .tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #1e293b;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 11px;
            font-weight: normal;
            line-height: 1.4;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <svg class="header-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="512" height="512" rx="100" fill="url(#grad1)"/>
                <path d="M120 400 L120 250 A 20 20 0 0 1 160 250 L160 400 Z" fill="#ffffff"/>
                <path d="M236 400 L236 180 A 20 20 0 0 1 276 180 L276 400 Z" fill="#ffffff"/>
                <path d="M352 400 L352 300 A 20 20 0 0 1 392 300 L392 400 Z" fill="#ffffff"/>
            </svg>
            <h1>Copilot Usage Tracker</h1>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <select id="yearSelect" onchange="loadSelectedData()"></select>
            <select id="monthSelect" onchange="loadSelectedData()"></select>
            <div class="status-labels">
                <div class="update-item">
                    <div class="update-time" id="lastUpdateTime"></div>
                    <div class="schedule-info" id="scheduleInfo"></div>
                </div>
                <div class="refresh-controls">
                    <button class="refresh-btn" onclick="manualRefresh()">Refresh Now</button>
                    <label class="auto-refresh-label">
                        <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()" checked> Auto Refresh
                    </label>
                </div>
            </div>
        </div>

        <div class="box">
            <div class="box-header">
                <h2 id="chartTitle">Monthly Usage Progress</h2>
                <div id="remainingIndicator" style="font-size: 14px; font-weight: 600;"></div>
            </div>
            <div class="chart-container">
                <canvas id="usageChart"></canvas>
            </div>
        </div>

        <div class="summary-grid" id="statsSummary" style="margin-bottom: 24px;">
            <!-- Overall statistics -->
        </div>

        <div class="summary-grid" id="modelSummary">
            <!-- Dynamic model summary cards -->
        </div>
    </div>

    <script>
        let currentChart = null;
        let latestData = null; // Store latest info (year, month, update time, cron)
        let autoRefreshInterval = null;
        
        // Base URL configuration: Use Raw GitHub to avoid GitHub Pages CDN cache
        const BASE_DATA_URL = 'https://raw.githubusercontent.com/waknow/bill-usage/refs/heads/main/data/';
        
        function getFetchUrl(path) {
            // Check if running locally (file protocol or localhost)
            const isLocal = window.location.hostname === 'localhost' || 
                            window.location.hostname === '127.0.0.1' || 
                            window.location.protocol === 'file:';
            // Use local path for local testing, otherwise use the Raw GitHub URL
            // Add cache busting timestamp for the latest.json if not local
            let url = isLocal ? path : BASE_DATA_URL + path.replace('data/', '');
            if (!isLocal && path.includes('latest.json')) {
                url += `?t=${Date.now()}`;
            }
            return url;
        }

        async function init() {
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            
            const now = new Date();
            const startYear = 2025;
            const endYear = now.getFullYear();

            // Only clear and rebuild if empty
            if (yearSelect.options.length === 0) {
                for (let y = endYear; y >= startYear; y--) {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y;
                    yearSelect.appendChild(opt);
                }

                const locale = navigator.language || 'en';
                for (let m = 1; m <= 12; m++) {
                    const opt = document.createElement('option');
                    opt.value = m.toString().padStart(2, '0');
                    const date = new Date(2000, m - 1, 1);
                    opt.textContent = date.toLocaleString(locale, { month: 'long' });
                    monthSelect.appendChild(opt);
                }
            }

            try {
                const latestRes = await fetch(getFetchUrl('data/latest.json'));
                if (!latestRes.ok) throw new Error();
                latestData = await latestRes.json();
                
                // Set defaults if not manually changed yet
                if (!window._manuallyChanged) {
                    yearSelect.value = latestData.year;
                    monthSelect.value = latestData.month.split('-')[1];
                }

                // Show next run info
                if (latestData.next_run) {
                    const nextDate = new Date(latestData.next_run);
                    document.getElementById('scheduleInfo').textContent = 
                        `Next Schedule at ${nextDate.toLocaleString([], { weekday: 'short', hour: '2-digit', minute: '2-digit' })}`;
                }
            } catch (e) {
                if (!window._manuallyChanged) {
                    yearSelect.value = now.getFullYear();
                    monthSelect.value = (now.getMonth() + 1).toString().padStart(2, '0');
                }
            }

            loadSelectedData();
            toggleAutoRefresh();
        }

        function manualRefresh() {
            const btn = document.querySelector('.refresh-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Updating...';
            btn.disabled = true;
            
            init().finally(() => {
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 500);
            });
        }

        function toggleAutoRefresh() {
            const isEnabled = document.getElementById('autoRefreshToggle').checked;
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            
            if (isEnabled) {
                // Refresh every 5 minutes
                autoRefreshInterval = setInterval(init, 5 * 60 * 1000);
            }
        }

        async function loadSelectedData() {
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            
            // Mark as manually changed after first load
            yearSelect.onmousedown = () => window._manuallyChanged = true;
            monthSelect.onmousedown = () => window._manuallyChanged = true;

            const year = yearSelect.value;
            const month = monthSelect.value;
            const period = `${year}-${month}`;
            const path = `data/${year}/${period}.json`;

            document.getElementById('chartTitle').textContent = `Monthly Usage Progress: ${period}`;

            // Show last update time ONLY if selecting the latest available month
            const updateLabel = document.getElementById('lastUpdateTime');
            if (latestData && latestData.year === year && latestData.month === period) {
                const date = new Date(latestData.last_update);
                updateLabel.textContent = `Updated at ${date.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })}`;
                updateLabel.style.display = 'block';
            } else {
                updateLabel.style.display = 'none';
            }

            try {
                const response = await fetch(getFetchUrl(path));
                if (!response.ok) throw new Error('Data not found');
                const data = await response.json();
                renderChart(data);
                updateSummary(data);
            } catch (err) {
                console.error(err);
                renderEmptyChart(`${year}-${month}`);
                document.getElementById('modelSummary').innerHTML = '';
            }
        }

        function renderEmptyChart(period) {
            const ctx = document.getElementById('usageChart').getContext('2d');
            if (currentChart) currentChart.destroy();

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                },
                plugins: [{
                    id: 'noData',
                    afterDraw: (chart) => {
                        const { ctx, width, height } = chart;
                        ctx.save();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = '16px "Inter", sans-serif';
                        ctx.fillStyle = '#64748b';
                        ctx.fillText(`No data found for ${period}`, width / 2, height / 2);
                        ctx.restore();
                    }
                }]
            });
        }

        function renderChart(data) {
            const labels = Object.keys(data);
            const plannedData = labels.map(date => data[date].planned);
            const actualData = labels.map(date => data[date].actual || 0);

            const modelNames = new Set();
            labels.forEach(date => {
                if (data[date].models) {
                    Object.keys(data[date].models).forEach(m => modelNames.add(m));
                }
            });
            const sortedModels = Array.from(modelNames).sort();

            const now = new Date();
            const todayStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;

            const efficiencyData = labels.map((date, i) => {
                // Do not draw efficiency background for future dates
                if (date > todayStr) return null;

                const p = plannedData[i];
                const a = actualData[i];
                let val = (p > 0) ? ((a / p) - 1) * 100 : 0;
                return Math.min(Math.max(val, -100), 100);
            });

            const datasets = [];

            // 1. Efficiency Background (Area)
            datasets.push({
                label: 'Efficiency Variance',
                data: efficiencyData,
                yAxisID: 'yEfficiency',
                pointRadius: 0,
                borderWidth: 1,
                borderColor: 'rgba(0,0,0,0.05)',
                tension: 0.3,
                fill: {
                    target: 'origin',
                    above: 'rgba(239, 68, 68, 0.15)', // Rose tint (over usage)
                    below: 'rgba(34, 197, 94, 0.15)'  // Green tint (efficient)
                },
                type: 'line',
                order: 10 // Bottom
            });

            // 2. Planned Target Line
            datasets.push({
                label: 'Planned Target',
                data: plannedData,
                borderColor: '#6366f1',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                tension: 0.4,
                pointRadius: 0,
                type: 'line',
                order: 0 // Top
            });

            // 3. Actual Usage Bars (Stacked)
            // Modern Vivid Palette
            const colors = [
                '#818cf8', // Indigo
                '#38bdf8', // Sky
                '#34d399', // Emerald
                '#fbbf24', // Amber
                '#f87171', // Red/Rose
                '#a78bfa', // Violet
                '#2dd4bf'  // Teal
            ];
            sortedModels.forEach((model, index) => {
                datasets.push({
                    label: model,
                    data: labels.map(date => (data[date].models ? data[date].models[model] || 0 : 0)),
                    backgroundColor: colors[index % colors.length],
                    borderRadius: 4,
                    borderWidth: 0,
                    stack: 'actual',
                    type: 'bar',
                    order: 1
                });
            });

            const ctx = document.getElementById('usageChart').getContext('2d');
            if (currentChart) currentChart.destroy();

            currentChart = new Chart(ctx, {
                data: {
                    labels: labels.map(l => parseInt(l.split('-')[2])),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                boxHeight: 12,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { size: 12, weight: '500' }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            stacked: true, 
                            grid: { display: false },
                            ticks: { 
                                color: '#94a3b8', 
                                font: { size: 11 },
                                maxRotation: 0
                            }
                        },
                        y: { 
                            beginAtZero: true,
                            stacked: true,
                            grid: { color: '#f8fafc' },
                            border: { dash: [4, 4], display: false },
                            ticks: { 
                                color: '#94a3b8', 
                                font: { size: 11 },
                                callback: (v) => v.toFixed(0)
                            }
                        },
                        yEfficiency: {
                            display: false,
                            min: -100,
                            max: 100
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: '#1e293b',
                            padding: 12,
                            titleFont: { size: 13, weight: '700' },
                            bodyFont: { size: 12 },
                            cornerRadius: 8,
                            callbacks: {
                                label: (context) => {
                                    if (context.dataset.label === 'Efficiency Variance') return null;
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}`;
                                },
                                footer: (items) => {
                                    const idx = items[0].dataIndex;
                                    const p = plannedData[idx];
                                    let total = 0;
                                    items.forEach(item => { if (item.dataset.type === 'bar') total += item.raw; });
                                    const ratio = (p > 0) ? (total / p * 100) : 0;
                                    return `Total: ${total.toFixed(1)} (${ratio.toFixed(1)}%)`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            padding: 24,
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 6,
                                boxHeight: 6,
                                padding: 20,
                                font: { size: 12, weight: '500' },
                                color: '#1e293b',
                                filter: (item) => item.text !== 'Efficiency Variance'
                            }
                        }
                    }
                }
            });
        }

        function updateSummary(data) {
            const statsContainer = document.getElementById('statsSummary');
            const modelsContainer = document.getElementById('modelSummary');
            statsContainer.innerHTML = '';
            modelsContainer.innerHTML = '';
            
            const now = new Date();
            const todayStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            const keys = Object.keys(data).sort();
            const lastDate = keys[keys.length - 1];

            // 1. Calculate Remaining & Monthly Progress
            let currentActual = 0;
            for (let i = keys.length - 1; i >= 0; i--) {
                if (data[keys[i]].actual !== undefined && keys[i] <= todayStr) {
                    currentActual = data[keys[i]].actual;
                    break;
                }
            }

            const currentPlanned = data[todayStr] ? data[todayStr].planned : (data[lastDate] ? data[lastDate].planned : 0);
            const remaining = currentPlanned - currentActual;

            // 2. Update Header Indicator (Only for current month)
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            const isCurrentMonth = (yearSelect.value == now.getFullYear() && monthSelect.value == (now.getMonth() + 1).toString().padStart(2, '0'));
            const indicator = document.getElementById('remainingIndicator');
            
            if (isCurrentMonth && indicator) {
                if (remaining >= 0) {
                    indicator.innerHTML = `Remaining Today: <span style="color: var(--success-color)">+${remaining.toFixed(0)}</span>`;
                } else {
                    indicator.innerHTML = `Overused Today: <span style="color: var(--danger-color)">${remaining.toFixed(0)}</span>`;
                }
                indicator.style.display = 'block';
            } else if (indicator) {
                indicator.style.display = 'none';
            }

            // 3. Add Summary Cards
            if (isCurrentMonth) {
                const color = remaining >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                addSummaryCard('Remaining Today', remaining.toFixed(1), color, statsContainer);
            }
            
            addSummaryCard('Total Month-to-Date', currentActual.toFixed(1), 
                (currentActual > currentPlanned) ? 'var(--danger-color)' : 'var(--success-color)', 
                statsContainer, `/ ${currentPlanned.toFixed(0)}`, 'Target is calculated based on monthly quota and workdays distribution');

            // Model breakdown (find last day with models)
            let modelData = null;
            for (let i = keys.length - 1; i >= 0; i--) {
                if (data[keys[i]].models) {
                    modelData = data[keys[i]].models;
                    break;
                }
            }

            if (modelData) {
                const totalModelUsage = Object.values(modelData).reduce((a, b) => a + b, 0);
                Object.entries(modelData).sort((a,b) => b[1] - a[1]).forEach(([name, val]) => {
                    const percentage = totalModelUsage > 0 ? (val / totalModelUsage * 100).toFixed(1) : 0;
                    addSummaryCard(name, val.toFixed(2), null, modelsContainer, `${percentage}%`);
                });
            }
        }

        function addSummaryCard(label, value, color, container, subtitle, info) {
            const target = container || document.getElementById('modelSummary');
            const div = document.createElement('div');
            div.className = 'summary-card';
            
            let html = `<div class="summary-label">${label}</div>`;
            html += `<div style="display: flex; align-items: baseline; gap: 6px; flex-wrap: wrap;">`;
            html += `<div class="summary-value" style="color: ${color || 'inherit'}">${value}</div>`;
            
            if (subtitle) {
                html += `<div style="font-size: 18px; color: var(--text-muted); font-weight: 500;">${subtitle}</div>`;
            }
            
            if (info) {
                // Using custom CSS tooltip for better visibility
                html += `<div class="tooltip" style="cursor: help; margin-left: 2px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-muted); opacity: 0.7; vertical-align: middle;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <span class="tooltip-text">${info}</span>
                </div>`;
            }
            
            html += `</div>`;
            div.innerHTML = html;
            target.appendChild(div);
        }

        init();
    </script>
</body>
</html>
